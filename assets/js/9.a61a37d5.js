(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{658:function(s,t,n){"use strict";n.r(t);var a=n(14),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("阅读本文，你需要首先知道：")]),s._v(" "),n("ol",[n("li",[s._v("浏览器的同源策略")]),s._v(" "),n("li",[s._v("跨域问题")]),s._v(" "),n("li",[s._v("JSONP原理")]),s._v(" "),n("li",[s._v("cookie原理")])])]),s._v(" "),n("p",[s._v("JSONP并不是一个好的跨域解决方案，它至少有着下面两个严重问题：")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("会打乱服务器的消息格式")]),s._v("：JSONP要求服务器响应一段JS代码，但在非跨域的情况下，服务器又需要响应一个正常的JSON格式")]),s._v(" "),n("li",[n("strong",[s._v("只能完成GET请求")]),s._v("：JSONP的原理会要求浏览器端生成一个"),n("code",[s._v("script")]),s._v("元素，而"),n("code",[s._v("script")]),s._v("元素发出的请求只能是"),n("code",[s._v("get")]),s._v("请求")])]),s._v(" "),n("p",[s._v("所以，CORS是一种更好的跨域解决方案。")]),s._v(" "),n("h2",{attrs:{id:"概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),n("p",[n("code",[s._v("CORS")]),s._v("是基于"),n("code",[s._v("http1.1")]),s._v("的一种跨域解决方案，它的全称是"),n("strong",[s._v("C")]),s._v("ross-"),n("strong",[s._v("O")]),s._v("rigin "),n("strong",[s._v("R")]),s._v("esource "),n("strong",[s._v("S")]),s._v("haring，跨域资源共享。")]),s._v(" "),n("p",[s._v("它的总体思路是："),n("strong",[s._v("如果浏览器要跨域访问服务器的资源，需要获得服务器的允许")])]),s._v(" "),n("p",[n("img",{attrs:{src:"http://mdrs.yuanjin.tech/img/image-20200421152122793.png",alt:"image-20200421152122793"}})]),s._v(" "),n("p",[s._v("而要知道，一个请求可以附带很多信息，从而会对服务器造成不同程度的影响")]),s._v(" "),n("p",[s._v("比如有的请求只是获取一些新闻，有的请求会改动服务器的数据")]),s._v(" "),n("p",[s._v("针对不同的请求，CORS规定了三种不同的交互模式，分别是：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("简单请求")])]),s._v(" "),n("li",[n("strong",[s._v("需要预检的请求")])]),s._v(" "),n("li",[n("strong",[s._v("附带身份凭证的请求")])])]),s._v(" "),n("p",[s._v("这三种模式从上到下层层递进，请求可以做的事越来越多，要求也越来越严格。")]),s._v(" "),n("p",[s._v("下面分别说明三种请求模式的具体规范。")]),s._v(" "),n("h2",{attrs:{id:"简单请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单请求"}},[s._v("#")]),s._v(" 简单请求")]),s._v(" "),n("p",[s._v("当浏览器端运行了一段ajax代码（无论是使用XMLHttpRequest还是fetch api），浏览器会首先判断它属于哪一种请求模式")]),s._v(" "),n("h3",{attrs:{id:"简单请求的判定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单请求的判定"}},[s._v("#")]),s._v(" 简单请求的判定")]),s._v(" "),n("p",[s._v("当请求"),n("strong",[s._v("同时满足")]),s._v("以下条件时，浏览器会认为它是一个简单请求：")]),s._v(" "),n("ol",[n("li",[n("p",[n("strong",[s._v("请求方法属于下面的一种：")])]),s._v(" "),n("ul",[n("li",[s._v("get")]),s._v(" "),n("li",[s._v("post")]),s._v(" "),n("li",[s._v("head")])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("请求头仅包含安全的字段，常见的安全字段如下：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Accept")])]),s._v(" "),n("li",[n("code",[s._v("Accept-Language")])]),s._v(" "),n("li",[n("code",[s._v("Content-Language")])]),s._v(" "),n("li",[n("code",[s._v("Content-Type")])]),s._v(" "),n("li",[n("code",[s._v("DPR")])]),s._v(" "),n("li",[n("code",[s._v("Downlink")])]),s._v(" "),n("li",[n("code",[s._v("Save-Data")])]),s._v(" "),n("li",[n("code",[s._v("Viewport-Width")])]),s._v(" "),n("li",[n("code",[s._v("Width")])])])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("请求头如果包含"),n("code",[s._v("Content-Type")]),s._v("，仅限下面的值之一：")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("text/plain")])]),s._v(" "),n("li",[n("code",[s._v("multipart/form-data")])]),s._v(" "),n("li",[n("code",[s._v("application/x-www-form-urlencoded")])])])])]),s._v(" "),n("p",[s._v("如果以上三个条件同时满足，浏览器判定为简单请求。")]),s._v(" "),n("p",[s._v("下面是一些例子：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 请求方法不满足要求，不是简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"PUT"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 加入了额外的请求头，不是简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    a"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"post"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// content-type不满足要求，不是简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"post"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"content-type"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"application/json"')]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h3",{attrs:{id:"简单请求的交互规范"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单请求的交互规范"}},[s._v("#")]),s._v(" 简单请求的交互规范")]),s._v(" "),n("p",[s._v("当浏览器判定某个"),n("strong",[s._v("ajax跨域请求")]),s._v("是"),n("strong",[s._v("简单请求")]),s._v("时，会发生以下的事情")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("请求头中会自动添加"),n("code",[s._v("Origin")]),s._v("字段")])])]),s._v(" "),n("p",[s._v("比如，在页面"),n("code",[s._v("http://my.com/index.html")]),s._v("中有以下代码造成了跨域")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 简单请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/news"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("请求发出后，请求头会是下面的格式：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("GET /api/news/ HTTP/1.1\nHost: crossdomain.com\nConnection: keep-alive\n...\nReferer: http://my.com/index.html\nOrigin: http://my.com\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("看到最后一行没，"),n("code",[s._v("Origin")]),s._v("字段会告诉服务器，是哪个源地址在跨域请求")]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[s._v("服务器响应头中应包含"),n("code",[s._v("Access-Control-Allow-Origin")])])])]),s._v(" "),n("p",[s._v("当服务器收到请求后，如果允许该请求跨域访问，需要在响应头中添加"),n("code",[s._v("Access-Control-Allow-Origin")]),s._v("字段")]),s._v(" "),n("p",[s._v("该字段的值可以是：")]),s._v(" "),n("ul",[n("li",[s._v("*：表示我很开放，什么人我都允许访问")]),s._v(" "),n("li",[s._v("具体的源：比如"),n("code",[s._v("http://my.com")]),s._v("，表示我就允许你访问")])]),s._v(" "),n("blockquote",[n("p",[s._v("实际上，这两个值对于客户端"),n("code",[s._v("http://my.com")]),s._v("而言，都一样，因为客户端才不会管其他源服务器允不允许，就关心自己是否被允许")]),s._v(" "),n("p",[s._v("当然，服务器也可以维护一个可被允许的源列表，如果请求的"),n("code",[s._v("Origin")]),s._v("命中该列表，才响应"),n("code",[s._v("*")]),s._v("或具体的源")]),s._v(" "),n("p",[n("strong",[s._v("为了避免后续的麻烦，强烈推荐响应具体的源")])])]),s._v(" "),n("p",[s._v("假设服务器做出了以下的响应：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("HTTP/1.1 200 OK\nDate: Tue, 21 Apr 2020 08:03:35 GMT\n...\nAccess-Control-Allow-Origin: http://my.com\n...\n\n消息体中的数据\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("当浏览器看到服务器允许自己访问后，高兴的像一个两百斤的孩子，于是，它就把响应顺利的交给js，以完成后续的操作")]),s._v(" "),n("p",[s._v("下图简述了整个交互过程")]),s._v(" "),n("p",[n("img",{attrs:{src:"http://mdrs.yuanjin.tech/img/image-20200421162846480.png",alt:"image-20200421162846480"}})]),s._v(" "),n("h2",{attrs:{id:"需要预检的请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#需要预检的请求"}},[s._v("#")]),s._v(" 需要预检的请求")]),s._v(" "),n("p",[s._v("简单的请求对服务器的威胁不大，所以允许使用上述的简单交互即可完成。")]),s._v(" "),n("p",[s._v("但是，如果浏览器不认为这是一种简单请求，就会按照下面的流程进行：")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("浏览器发送预检请求，询问服务器是否允许")])]),s._v(" "),n("li",[n("strong",[s._v("服务器允许")])]),s._v(" "),n("li",[n("strong",[s._v("浏览器发送真实请求")])]),s._v(" "),n("li",[n("strong",[s._v("服务器完成真实的响应")])])]),s._v(" "),n("p",[s._v("比如，在页面"),n("code",[s._v("http://my.com/index.html")]),s._v("中有以下代码造成了跨域")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 需要预检的请求")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://crossdomain.com/api/user"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  method"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// post 请求")]),s._v("\n  headers"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置请求头")]),s._v("\n    a"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    b"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"content-type"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"application/json"')]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  body"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("stringify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"袁小进"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" age"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置请求体")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("浏览器发现它不是一个简单请求，则会按照下面的流程与服务器交互")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("浏览器发送预检请求，询问服务器是否允许")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("OPTIONS /api/user HTTP/1.1\nHost: crossdomain.com\n...\nOrigin: http://my.com\nAccess-Control-Request-Method: POST\nAccess-Control-Request-Headers: a, b, content-type\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("可以看出，这并非我们想要发出的真实请求，请求中不包含我们的响应头，也没有消息体。")]),s._v(" "),n("p",[s._v("这是一个预检请求，它的目的是询问服务器，是否允许后续的真实请求。")]),s._v(" "),n("p",[s._v("预检请求"),n("strong",[s._v("没有请求体")]),s._v("，它包含了后续真实请求要做的事情")]),s._v(" "),n("p",[s._v("预检请求有以下特征：")]),s._v(" "),n("ul",[n("li",[s._v("请求方法为"),n("code",[s._v("OPTIONS")])]),s._v(" "),n("li",[s._v("没有请求体")]),s._v(" "),n("li",[s._v("请求头中包含\n"),n("ul",[n("li",[n("code",[s._v("Origin")]),s._v("：请求的源，和简单请求的含义一致")]),s._v(" "),n("li",[n("code",[s._v("Access-Control-Request-Method")]),s._v("：后续的真实请求将使用的请求方法")]),s._v(" "),n("li",[n("code",[s._v("Access-Control-Request-Headers")]),s._v("：后续的真实请求会改动的请求头")])])])]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[s._v("服务器允许")])])]),s._v(" "),n("p",[s._v("服务器收到预检请求后，可以检查预检请求中包含的信息，如果允许这样的请求，需要响应下面的消息格式")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("HTTP/1.1 200 OK\nDate: Tue, 21 Apr 2020 08:03:35 GMT\n...\nAccess-Control-Allow-Origin: http://my.com\nAccess-Control-Allow-Methods: POST\nAccess-Control-Allow-Headers: a, b, content-type\nAccess-Control-Max-Age: 86400\n...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("对于预检请求，不需要响应任何的消息体，只需要在响应头中添加：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Access-Control-Allow-Origin")]),s._v("：和简单请求一样，表示允许的源")]),s._v(" "),n("li",[n("code",[s._v("Access-Control-Allow-Methods")]),s._v("：表示允许的后续真实的请求方法")]),s._v(" "),n("li",[n("code",[s._v("Access-Control-Allow-Headers")]),s._v("：表示允许改动的请求头")]),s._v(" "),n("li",[n("code",[s._v("Access-Control-Max-Age")]),s._v("：告诉浏览器，多少秒内，对于同样的请求源、方法、头，都不需要再发送预检请求了")])]),s._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[n("strong",[s._v("浏览器发送真实请求")])])]),s._v(" "),n("p",[s._v("预检被服务器允许后，浏览器就会发送真实请求了，上面的代码会发生下面的请求数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /api/user HTTP/1.1\nHost: crossdomain.com\nConnection: keep-alive\n...\nReferer: http://my.com/index.html\nOrigin: http://my.com\n\n{"name": "袁小进", "age": 18 }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[n("strong",[s._v("服务器响应真实请求")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("HTTP/1.1 200 OK\nDate: Tue, 21 Apr 2020 08:03:35 GMT\n...\nAccess-Control-Allow-Origin: http://my.com\n...\n\n添加用户成功\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("可以看出，当完成预检之后，后续的处理与简单请求相同")]),s._v(" "),n("p",[s._v("下图简述了整个交互过程")]),s._v(" "),n("p",[n("img",{attrs:{src:"http://mdrs.yuanjin.tech/img/image-20200421165913320.png",alt:"image-20200421165913320"}})]),s._v(" "),n("h2",{attrs:{id:"附带身份凭证的请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#附带身份凭证的请求"}},[s._v("#")]),s._v(" 附带身份凭证的请求")]),s._v(" "),n("p",[s._v("默认情况下，ajax的跨域请求并不会附带cookie，这样一来，某些需要权限的操作就无法进行")]),s._v(" "),n("p",[s._v("不过可以通过简单的配置就可以实现附带cookie")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// xhr")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" xhr "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("XMLHttpRequest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nxhr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("withCredentials "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// fetch api")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("url"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  credentials"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"include"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("这样一来，该跨域的ajax请求就是一个"),n("em",[s._v("附带身份凭证的请求")])]),s._v(" "),n("p",[s._v("当一个请求需要附带cookie时，无论它是简单请求，还是预检请求，都会在请求头中添加"),n("code",[s._v("cookie")]),s._v("字段")]),s._v(" "),n("p",[s._v("而服务器响应时，需要明确告知客户端：服务器允许这样的凭据")]),s._v(" "),n("p",[s._v("告知的方式也非常的简单，只需要在响应头中添加："),n("code",[s._v("Access-Control-Allow-Credentials: true")]),s._v("即可")]),s._v(" "),n("p",[s._v("对于一个附带身份凭证的请求，若服务器没有明确告知，浏览器仍然视为跨域被拒绝。")]),s._v(" "),n("p",[s._v("另外要特别注意的是："),n("strong",[s._v("对于附带身份凭证的请求，服务器不得设置 "),n("code",[s._v("Access-Control-Allow-Origin 的值为*")])]),s._v("。这就是为什么不推荐使用*的原因")]),s._v(" "),n("h2",{attrs:{id:"一个额外的补充"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一个额外的补充"}},[s._v("#")]),s._v(" 一个额外的补充")]),s._v(" "),n("p",[s._v("在跨域访问时，JS只能拿到一些最基本的响应头，如：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。")]),s._v(" "),n("p",[n("code",[s._v("Access-Control-Expose-Headers")]),s._v("头让服务器把允许浏览器访问的头放入白名单，例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Access-Control-Expose-Headers: authorization, a, b\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("这样JS就能够访问指定的响应头了。")])])}),[],!1,null,null,null);t.default=e.exports}}]);